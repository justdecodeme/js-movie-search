<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Movie Search</title>
		<style>
			#paginationEl li {
				width: 20px;
				display: inline-block;
				cursor: pointer;
			}
			#paginationEl li.active {
				background-color: lightblue;
			}
			#paginationEl li.active:hover {
				cursor: default;
			}
			#moviesEl {
				margin: 0;
				padding: 0;
			}
			li {
				display: block;
				background-color: salmon;
				width: 250px;
				margin: 10px;
				padding: 10px;
			}
			li:hover {
				background-color: yellow;
			}
		</style>
	</head>
	<body>
		<label for="title">Title</label>
		<input id="titleEl" type="text" placeholder="Text" />
		<label for="language">Language</label>
		<select id="languagesEl"></select>
		<button id="searchBtnEl">Search</button>

		<ul id="paginationEl">
			<li class="active">1</li>
			<li>2</li>
			<li>3</li>
		</ul>

		<ul id="searchHistoryEl"></ul>

		<ul id="moviesEl"></ul>

		<script>
			let xhttp = null;
			let movies = [];
			let languages = {};
			let page = 1;
			let url = `https://api.themoviedb.org/3/movie/upcoming?api_key=81f382d33088c6d52099a62eab51d967&language=en-US&page=`;

			let languagesEl = document.getElementById("languagesEl");
			let titleEl = document.getElementById("titleEl");
			let searchHistory = [];
			let searchHistoryLimit = 3;
			let oldFilterObj = { text: "", lang: "" };
			let filterObj = { text: "", lang: "" };

			/* ********** */
			/* MOVIE LIST */
			/* ********** */
			const loadMovies = (url, isFilter) => {
				console.log("Loading movies...");
				xhttp = new XMLHttpRequest();
				xhttp.onreadystatechange = function () {
					try {
						if (this.readyState == 4) {
							if (this.status === 200) {
								movies = JSON.parse(this.responseText).results;
								renderMovies(isFilter);
							} else {
								alert("There was a problem with the request.");
							}
						}
					} catch (e) {
						alert("Server error, try again!");
					}
				};

				xhttp.open("GET", url, true);
				xhttp.send();
			};

			const renderMovies = (isFilter, isClicked = false) => {
				if (oldFilterObj.text !== filterObj.text || oldFilterObj.lang !== filterObj.lang || !isClicked) {
					console.log("Rendering movies...");
					let filterMovies = [...movies];

					if (isFilter) {
						filterMovies = movies.filter((movie) => {
							let filterText = true;
							let filterLang = true;

							if (filterObj.text.toLowerCase() !== "") {
								filterText = movie.original_title.toLowerCase().indexOf(filterObj.text.toLowerCase()) > -1;
							}
							if (filterObj.lang !== "all") {
								filterLang = movie.original_language === filterObj.lang;
							}

							return filterText && filterLang;
						});
					}

					let moviesEl = document.getElementById("moviesEl");

					moviesEl.innerHTML = "";

					filterMovies.forEach((movie, ind) => {
						let li = document.createElement("li");
						// li.addEventListener("mouseover", () => {
						// 	togglePreview(movie.id);
						// });
						// li.addEventListener("mouseout", () => {
						// 	togglePreview();
						// });
						let i = movie.original_title.toLowerCase().indexOf(filterObj.text.toLowerCase());
						let start = movie.original_title.substring(0, i);
						let middle = filterObj.text;
						let end = movie.original_title.substring(i + filterObj.text.length, movie.original_title.length);
						let movieTitle = `${start}<b><u>${middle}</u></b>${end}`;
						console.log(start, middle, end);
						li.setAttribute("id", movie.id);
						li.innerHTML = `${movieTitle} | ${movie.original_language} | ${movie.vote_average}`;
						moviesEl.append(li);

						if (languagesEl.innerHTML === "") {
							languagesEl.innerHTML = `<option value="all">All</option>`;
						}
						if (!languages[movie.original_language]) {
							languages[movie.original_language] = movie.original_language;
							let option = document.createElement("option");
							option.setAttribute("value", movie.original_language);
							option.innerHTML = movie.original_language;
							languagesEl.append(option);
						}
					});

					if (isClicked) {
						let searchHistoryEl = document.getElementById("searchHistoryEl");

						if (searchHistory.length === searchHistoryLimit) {
							searchHistory[2] = searchHistory[1];
							searchHistory[1] = searchHistory[0];
							searchHistory[0] = filterObj;
						} else {
							searchHistory.unshift(filterObj);
						}

						searchHistoryEl.innerHTML = "";
						searchHistory.forEach((search) => {
							let li = document.createElement("li");
							li.innerHTML = `${search.text} / ${search.lang}`;
							searchHistoryEl.append(li);
						});
					}
					oldFilterObj = { ...filterObj };
				}
			};

			const togglePreview = (id) => {
				console.log("Toggle preview...", id);

				/* show movie content on mouseover */
				if (id) {
					xhttp = new XMLHttpRequest();
					xhttp.onreadystatechange = function () {
						try {
							if (this.readyState == 4 && this.status == 200) {
								let movies = JSON.parse(this.responseText).results;
								movies.forEach((movie) => {
									if (movie.id === id) {
										console.log(movie.overview);
										let el = document.getElementById(`${id}`);
										el.innerHTML += `<p>${movie.overview}</p>`;
									}
								});
							}
						} catch (e) {
							alert("Server error, try again!");
						}
					};

					xhttp.open("GET", url, true);
					xhttp.send();
					/* hide content if data not fetched and mouseout */
				} else {
					xhttp.abort();
				}
			};

			window.addEventListener("load", (event) => {
				loadMovies(url + page, false);
			});

			/* ********** */
			/* PAGINATION */
			/* ********** */
			const paginationEl = document.querySelectorAll("#paginationEl li");

			paginationEl.forEach((pagination) => {
				pagination.addEventListener("click", (e) => {
					let oldTarget = document.querySelector("#paginationEl li.active");
					let target = e.target;

					if (oldTarget !== target) {
						oldTarget.classList.remove("active");
						target.classList.add("active");
						page = +e.target.innerHTML;
						loadMovies(url + page, true);
					}
				});
			});

			/* ********** */
			/* SEARCH */
			/* ********** */
			const searchBtnEl = document.getElementById("searchBtnEl");

			searchBtnEl.addEventListener("click", () => {
				filterObj = { text: titleEl.value, lang: languagesEl.value };
				renderMovies(true, true);
			});

			/* ********** */
			/* HISTORY */
			/* ********** */
		</script>
	</body>
</html>
